<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Smart Parsing Monitor</title>
    <style>
        /* === ìŠ¤íƒ€ì¼ì€ ê¸°ì¡´ê³¼ ë™ì¼ === */
        * { box-sizing: border-box; }
        body { margin: 0; padding: 10px; font-family: 'Segoe UI', sans-serif; background: #f4f6f9; height: 100vh; display: flex; flex-direction: column; gap: 10px; min-width: 900px; }
        .box { background: white; border: 1px solid #ccc; border-radius: 4px; padding: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .disabled-state { background-color: #f9f9f9 !important; filter: grayscale(100%); opacity: 0.6; pointer-events: none; }
        .section-graph { flex: 7; position: relative; min-height: 0; }
        .section-table { flex: 2; display: flex; flex-direction: column; overflow: hidden; }
        .table-scroll { overflow-x: auto; height: 100%; border: 1px solid #ddd; }
        table { width: 100%; border-collapse: collapse; text-align: center; table-layout: fixed; min-width: 700px; }
        th, td { border: 1px solid #ccc; padding: 6px; font-size: 13px; }
        td:first-child, th:first-child { background: #e9ecef; font-weight: bold; width: 80px; }
        thead th { background: #eaeff5; position: sticky; top: 0; }
        .section-footer { flex: 1; display: flex; align-items: center; justify-content: space-between; gap: 10px; width: 100%; }
        .footer-center { display: none; flex: 1; align-items: center; background: #fff; border: 1px solid #ccc; border-radius: 4px; padding: 5px 10px; height: 100%; gap: 10px; }
        .input-grid-container { display: grid; grid-template-columns: repeat(10, 1fr); gap: 5px; width: 100%; }
        .test-input { width: 100%; text-align: center; border: 1px solid #ddd; border-radius: 3px; padding: 5px 0; font-weight: bold; }
        button { height: 40px; padding: 0 15px; font-weight: bold; cursor: pointer; border: 1px solid #999; background: white; border-radius: 4px; }
        button:hover { background: #eee; }
        #btnSend { background-color: #ff9800; color: white; border: none; }
        .btn-connected { border-left: 5px solid #4CAF50 !important; color: #2e7d32 !important; background-color: white !important; }
        .btn-disconnected { border-left: 5px solid #999 !important; color: #888 !important; background-color: #f0f0f0 !important; }
        #btnExport { border-right: 5px solid #008CBA; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-window { background: white; width: 400px; padding: 20px; border-radius: 8px; display: flex; flex-direction: column; gap: 15px; }
        .modal-header { font-size: 18px; font-weight: bold; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .modal-footer { display: flex; justify-content: space-between; margin-top: 10px; }
        .modal-footer button { width: 45%; }
        .btn-ok { background-color: #007bff; color: white; border: none; }
        .port-list { list-style: none; padding: 0; margin: 0; border: 1px solid #ddd; max-height: 200px; overflow-y: auto; }
        .port-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .port-item.selected { background-color: #007bff; color: white; }
        .save-filename { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="box section-graph disabled-state" id="graphArea"><canvas id="myChart"></canvas></div>
    <div class="box section-table disabled-state" id="tableArea">
        <div style="font-weight:bold; margin-bottom:5px;">:: Pulse Width ë°ì´í„° (10ê°œì”© ê°±ì‹ )</div>
        <div class="table-scroll">
            <table id="dataTable">
                <thead><tr><th>ID</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th><th>8</th><th>9</th><th>10</th></tr></thead>
                <tbody><tr id="dataRow"><td>ê°’(ms)</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td><td>0</td></tr></tbody>
            </table>
        </div>
    </div>
    <div class="section-footer">
        <div class="footer-left"><button id="btnPort" class="btn-disconnected">âš™ï¸ í¬íŠ¸ ì—°ê²°</button></div>
        <div class="footer-center" id="testPanel">
            <div class="input-grid-container">
                <input type="number" class="test-input" value="10"><input type="number" class="test-input" value="20"><input type="number" class="test-input" value="30"><input type="number" class="test-input" value="40"><input type="number" class="test-input" value="50"><input type="number" class="test-input" value="60"><input type="number" class="test-input" value="70"><input type="number" class="test-input" value="80"><input type="number" class="test-input" value="90"><input type="number" class="test-input" value="100">
            </div>
            <button id="btnSend">ğŸ“¤ SEND</button>
        </div>
        <div class="footer-right"><button id="btnExport">ğŸ’¾ ë¡œê·¸ ì €ì¥</button></div>
    </div>

    <div class="modal-overlay" id="portModal">
        <div class="modal-window">
            <div class="modal-header">í¬íŠ¸ ì„¤ì •</div>
            <ul class="port-list" id="portList"></ul>
            <div class="modal-footer"><button class="btn-cancel" id="btnPortCancel">Cancel</button><button class="btn-ok" id="btnPortOk">OK</button></div>
        </div>
    </div>
    <div class="modal-overlay" id="saveModal">
        <div class="modal-window">
            <div class="modal-header">ë¡œê·¸ ì €ì¥</div>
            <div><label>íŒŒì¼ ì´ë¦„</label><input type="text" class="save-filename" id="fileNameInput" value="log_data"></div>
            <div style="font-size:12px; color:#666;">â„¹ï¸ ì—°ê²°ì„ ëŠì–´ë„ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤.</div>
            <div class="modal-footer"><button class="btn-cancel" id="btnSaveCancel">Cancel</button><button class="btn-ok" id="btnSaveOk">ì €ì¥</button></div>
        </div>
    </div>

    <script src="./jquery.min.js"></script>
    <script src="./chart.min.js"></script>
    <script>
        const ctx = document.getElementById('myChart');
        const myChart = new Chart(ctx, {
            type: 'bar',
            data: { labels: ['1','2','3','4','5','6','7','8','9','10'], datasets: [{ label: 'Pulse Width (ms)', data: [0,0,0,0,0,0,0,0,0,0], backgroundColor: '#4472C4' }] },
            options: { responsive: true, maintainAspectRatio: false, animation: { duration: 0 } }
        });

        let isConnected = false; let selectedPort = null; let logBuffer = []; let eventSource = null;

        function toggleUI(connected) {
            if (connected) {
                $('#graphArea, #tableArea').removeClass('disabled-state');
                $('#btnPort').removeClass('btn-disconnected').addClass('btn-connected').text('âœ… ì—°ê²°ë¨: ' + selectedPort);
                if(selectedPort.includes('TEST')) { $('#testPanel').css('display', 'flex'); }
                else {
                    $('#testPanel').hide();
                    if(eventSource) eventSource.close();
                    eventSource = new EventSource('/api/stream');
                    eventSource.onmessage = function(event) {
                        const valArray = event.data.split(',').map(Number);
                        if(valArray.length === 10) updateGraphAndTable(valArray);
                    };
                }
            } else {
                $('#graphArea, #tableArea').addClass('disabled-state');
                $('#testPanel').hide();
                $('#btnPort').removeClass('btn-connected').addClass('btn-disconnected').text('âš™ï¸ í¬íŠ¸ ì—°ê²° (í•´ì œë¨)');
                if(eventSource) { eventSource.close(); eventSource = null; }
            }
        }

        function updateGraphAndTable(newValues) {
            myChart.data.datasets[0].data = newValues;
            myChart.update();
            $('#dataRow td').each(function(index) { if (index > 0) $(this).text(newValues[index - 1]); });
            const timestamp = new Date().toLocaleString();
            const tag = (selectedPort && selectedPort.includes('TEST')) ? 'TEST' : '';
            logBuffer.push({ time: timestamp, values: newValues, tag: tag });
        }

        $('#btnPort').click(function() {
            if (isConnected) {
                if(confirm('ì—°ê²°ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ë°ì´í„° ìœ ì§€ë¨)')) { isConnected = false; toggleUI(false); }
            } else {
                $.ajax({ url: '/api/ports', method: 'GET', success: function(ports) {
                    const $list = $('#portList'); $list.empty();
                    $list.append(`<li class="port-item">TEST (Virtual Mode)</li>`);
                    ports.forEach(p => $list.append(`<li class="port-item">${p}</li>`));
                    $('#portModal').css('display', 'flex');
                }, error: function() { alert('ì„œë²„ ì—°ê²° ì‹¤íŒ¨'); } });
            }
        });

        $(document).on('click', '.port-item', function() { $('.port-item').removeClass('selected'); $(this).addClass('selected'); selectedPort = $(this).text(); });
        $('#btnPortOk').click(function() {
            if (!selectedPort) { alert('í¬íŠ¸ ì„ íƒ!'); return; }
            $('#portModal').hide();
            $.ajax({ url: '/api/connect', method: 'POST', contentType: 'application/json', data: JSON.stringify({ port: selectedPort }),
                success: function(res) { alert(res.message); logBuffer = []; isConnected = true; toggleUI(true); },
                error: function() { alert('ì¥ì¹˜ ì—°ê²° ì‹¤íŒ¨'); }
            });
        });

        $('#btnSend').click(function() { if(!isConnected) return; let vals = []; $('.test-input').each(function() { vals.push(Number($(this).val()) || 0); }); updateGraphAndTable(vals); });
        $('#btnExport').click(function() { const now = new Date(); $('#fileNameInput').val(`log_${now.getTime()}`); $('#saveModal').css('display', 'flex'); });
        $('#btnSaveCancel').click(() => $('#saveModal').hide()); $('#btnPortCancel').click(() => $('#portModal').hide());
        $('#btnSaveOk').click(function() {
            const fileName = $('#fileNameInput').val() || 'log_data';
            if (logBuffer.length === 0) { alert("ì €ì¥í•  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            let csv = "Time,CH1,CH2,CH3,CH4,CH5,CH6,CH7,CH8,CH9,CH10,Mode\n";
            logBuffer.forEach(r => csv += `${r.time},${r.values.join(',')},${r.tag}\n`);
            const blob = new Blob(["\ufeff" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = fileName + ".csv"; link.click(); $('#saveModal').hide();
        });
    </script>
</body>
</html>